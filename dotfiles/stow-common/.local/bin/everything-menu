#!/usr/bin/env bash

# Everything Menu - Command Center with nested sub-menus
# Structure defined in: documentation/everything-menu-structure.md

ROFI_OPTS="-dmenu -i -markup-rows"

show_rofi() {
    local prompt="$1"
    shift
    echo -e "$@" | rofi $ROFI_OPTS -kb-cancel "" -kb-custom-1 "Escape" -p "$prompt"
    return $?
}

notify() {
    notify-send -t 2000 "Everything Menu" "$1"
}

edit_config() {
    kitty --title "Edit: $1" -e nvim "$2"
}

# ============================================
# MAIN MENU
# ============================================
main_menu() {
    while true; do
        # Check hyprsunset state for toggle display
        if pgrep -x hyprsunset > /dev/null; then
            sunset_entry="󱩐  Hyprsunset (ON)"
        else
            sunset_entry="󱩐  Hyprsunset (OFF)"
        fi

        # Check timer state
        timer_status=$(timer status 2>/dev/null)
        if [[ "$timer_status" == "ringing" ]]; then
            timer_entry="󰂞  Timer (ALARM!)"
        elif [[ "$timer_status" == "running" ]]; then
            timer_remaining=$(timer remaining 2>/dev/null)
            timer_entry="󰄉  Timer ($timer_remaining)"
        else
            timer_entry="󰄉  Timer"
        fi

        menu=$(
            cat <<EOF
󰒼  Config
󰆏  Screenshots
󰣀  SSH
󰂯  Bluetooth
󰕾  Audio
󰗀  Themes
󰖩  Wi-Fi
󰸉  Wallpaper
$timer_entry
󰏘  Color Picker
$sunset_entry
󰎈  Media
󰒓  System
EOF
        )

        choice=$(show_rofi "Menu" "$menu")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            exit 0
        fi

        case "$choice" in
            *"System"*) system_menu ;;
            *"Wi-Fi"*) wifi_menu ;;
            *"Bluetooth"*) bluetooth_menu ;;
            *"Audio"*) audio_menu ;;
            *"Screenshots"*) screenshots_menu ;;
            *"Media"*) media_menu ;;
            *"Themes"*) themes_menu ;;
            *"Wallpaper"*) wallpaper_menu ;;
            *"Config"*) config_menu ;;
            *"SSH"*) ssh_menu ;;
            *"Timer"*) timer_menu ;;
            *"Color Picker"*)
                color=$(hyprpicker -a)
                [[ -n "$color" ]] && notify "Copied: $color"
                ;;
            *"Hyprsunset"*)
                if pgrep -x hyprsunset > /dev/null; then
                    pkill hyprsunset
                    notify "Hyprsunset disabled"
                else
                    hyprsunset -t 4500 &
                    notify "Hyprsunset enabled (4500K)"
                fi
                ;;
            "") exit 0 ;;
        esac
    done
}

# ============================================
# SYSTEM
# ============================================
system_menu() {
    while true; do
        choice=$(show_rofi "System" \
"󰐥  Shutdown
󰜉  Reboot
󰤄  Suspend
󰒳  Lock
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Shutdown"*) systemctl poweroff ;;
            *"Reboot"*) systemctl reboot ;;
            *"Suspend"*) systemctl suspend ;;
            *"Lock"*) hyprlock ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# SSH
# ============================================
ssh_menu() {
    # Parse SSH config for hosts (excluding wildcards)
    hosts=$(grep -E "^Host " ~/.ssh/config 2>/dev/null | awk '{print $2}' | grep -v '\*')

    if [[ -z "$hosts" ]]; then
        notify "No SSH hosts found in ~/.ssh/config"
        return
    fi

    # Build menu entries
    menu_entries=$(echo "$hosts" | while read -r host; do
        echo "󰣀  $host"
    done)
    menu_entries="$menu_entries
←  Back"

    while true; do
        choice=$(show_rofi "SSH" "$menu_entries")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Back"*|"") break ;;
            *)
                # Extract hostname from selection
                host=$(echo "$choice" | sed 's/󰣀  //')
                kitty --title "SSH: $host" -e ssh "$host" &
                exit 0
                ;;
        esac
    done
}

# ============================================
# TIMER
# ============================================
timer_menu() {
    while true; do
        # Check timer state for dynamic menu
        timer_status=$(timer status 2>/dev/null)

        if [[ "$timer_status" == "ringing" ]]; then
            choice=$(show_rofi "Timer (ALARM!)" \
"󰂛  Dismiss Alarm
←  Back")
        elif [[ "$timer_status" == "running" ]]; then
            timer_remaining=$(timer remaining 2>/dev/null)
            choice=$(show_rofi "Timer ($timer_remaining)" \
"󰜺  Cancel Timer
←  Back")
        else
            choice=$(show_rofi "Timer" \
"󰄉  Set Timer
󰥔  5 minutes
󰥔  10 minutes
󰥔  15 minutes
󰥔  30 minutes
←  Back")
        fi
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            exit 0
        fi

        case "$choice" in
            *"Dismiss"*)
                timer dismiss
                ;;
            *"Cancel"*)
                timer cancel
                ;;
            *"Set Timer"*)
                minutes=$(rofi -dmenu -p "Minutes" -theme-str 'entry { placeholder: "Enter minutes..."; }')
                if [[ -n "$minutes" && "$minutes" =~ ^[0-9]+$ ]]; then
                    timer set "$minutes"
                    exit 0
                fi
                ;;
            *"5 minutes"*)
                timer set 5
                exit 0
                ;;
            *"10 minutes"*)
                timer set 10
                exit 0
                ;;
            *"15 minutes"*)
                timer set 15
                exit 0
                ;;
            *"30 minutes"*)
                timer set 30
                exit 0
                ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# WI-FI
# ============================================
wifi_menu() {
    while true; do
        # Check wifi status for toggle display
        if nmcli radio wifi | grep -q enabled; then
            toggle_entry="󰤨  Toggle (ON)"
        else
            toggle_entry="󰤭  Toggle (OFF)"
        fi

        choice=$(show_rofi "Wi-Fi" \
"󰖩  Connect
󰖩  Status
$toggle_entry
󰖪  Disconnect
󰌆  Settings
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Connect"*)
                # Scan and list networks with signal strength
                networks=$(nmcli -t -f SSID,SIGNAL,SECURITY device wifi list | grep -v '^:' | sort -t: -k2 -nr | awk -F: '{
                    signal=$2
                    if (signal >= 75) icon="󰤨"
                    else if (signal >= 50) icon="󰤥"
                    else if (signal >= 25) icon="󰤢"
                    else icon="󰤟"
                    security=$3 ? "󰌆" : ""
                    printf "%s %s %s %s\n", icon, $1, security, signal"%"
                }')

                if [[ -z "$networks" ]]; then
                    notify "No networks found"
                else
                    selected=$(echo "$networks" | rofi $ROFI_OPTS -p "Connect")
                    if [[ -n "$selected" ]]; then
                        # Extract SSID (second field after icon)
                        ssid=$(echo "$selected" | awk '{print $2}')
                        nmcli device wifi connect "$ssid" && notify "Connected to $ssid" || notify "Failed to connect"
                    fi
                fi
                ;;
            *"Status"*)
                active=$(nmcli -t -f NAME,DEVICE connection show --active | grep -v "lo:" | head -1)
                if [[ -n "$active" ]]; then
                    name=$(echo "$active" | cut -d: -f1)
                    device=$(echo "$active" | cut -d: -f2)
                    ip=$(nmcli -t -f IP4.ADDRESS device show "$device" | cut -d: -f2 | head -1)
                    notify "Connected: $name\nIP: $ip"
                else
                    notify "Not connected"
                fi
                ;;
            *"Toggle"*)
                nmcli radio wifi toggle
                sleep 0.5
                if nmcli radio wifi | grep -q enabled; then
                    notify "Wi-Fi enabled"
                else
                    notify "Wi-Fi disabled"
                fi
                ;;
            *"Disconnect"*)
                active=$(nmcli -t -f NAME,TYPE connection show --active | grep wireless | cut -d: -f1)
                if [[ -n "$active" ]]; then
                    nmcli connection down "$active" && notify "Disconnected from $active"
                else
                    notify "No active connection"
                fi
                ;;
            *"Settings"*)
                kitty --title "Wi-Fi Settings" -e nmtui &
                ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# BLUETOOTH
# ============================================
bluetooth_menu() {
    while true; do
        # Check bluetooth status for toggle display
        if bluetoothctl show | grep -q "Powered: yes"; then
            toggle_entry="󰂯  Toggle (ON)"
        else
            toggle_entry="󰂲  Toggle (OFF)"
        fi

        choice=$(show_rofi "Bluetooth" \
"󰂱  Connect
󰂯  Status
$toggle_entry
󰂲  Disconnect
󰒓  Settings
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Connect"*)
                # List paired devices first, then scan for new ones
                devices=$(bluetoothctl devices | awk '{
                    mac=$2
                    $1=$2=""
                    name=substr($0,3)
                    printf "󰂱  %s (%s)\n", name, mac
                }')

                if [[ -z "$devices" ]]; then
                    notify "No paired devices. Opening settings..."
                    kitty --title "Bluetooth" -e bluetoothctl &
                else
                    selected=$(echo "$devices" | rofi $ROFI_OPTS -p "Connect")
                    if [[ -n "$selected" ]]; then
                        # Extract MAC address from selection
                        mac=$(echo "$selected" | grep -oE '[0-9A-F:]{17}')
                        bluetoothctl connect "$mac" && notify "Connected" || notify "Failed to connect"
                    fi
                fi
                ;;
            *"Status"*)
                connected=$(bluetoothctl devices Connected | awk '{$1=$2=""; print substr($0,3)}' | head -1)
                if [[ -n "$connected" ]]; then
                    notify "Connected: $connected"
                else
                    notify "No device connected"
                fi
                ;;
            *"Toggle"*)
                if bluetoothctl show | grep -q "Powered: yes"; then
                    bluetoothctl power off
                    notify "Bluetooth disabled"
                else
                    bluetoothctl power on
                    notify "Bluetooth enabled"
                fi
                ;;
            *"Disconnect"*)
                connected_mac=$(bluetoothctl devices Connected | awk '{print $2}' | head -1)
                if [[ -n "$connected_mac" ]]; then
                    bluetoothctl disconnect "$connected_mac" && notify "Disconnected"
                else
                    notify "No device connected"
                fi
                ;;
            *"Settings"*)
                kitty --title "Bluetooth" -e bluetuith &
                exit 0
                ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# AUDIO
# ============================================
audio_menu() {
    while true; do
        # Get current output and mute state
        current_sink=$(wpctl inspect @DEFAULT_AUDIO_SINK@ 2>/dev/null | grep "node.description" | cut -d'"' -f2)
        [[ -z "$current_sink" ]] && current_sink="Unknown"

        if wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null | grep -q MUTED; then
            mute_entry="󰖁  Toggle Mute (ON)"
        else
            mute_entry="󰕾  Toggle Mute (OFF)"
        fi

        choice=$(show_rofi "Audio ($current_sink)" \
"󰓃  Output Device
󰍬  Input Device
$mute_entry
󰍭  Mute Mic
󰒓  Settings
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Output Device"*)
                # List audio sinks
                sinks=$(pactl list sinks short | while read -r id name _; do
                    desc=$(pactl list sinks | grep -A 20 "Sink #$id" | grep "Description:" | cut -d: -f2 | xargs)
                    echo "󰓃  $desc"
                done)

                if [[ -n "$sinks" ]]; then
                    selected=$(echo "$sinks" | rofi $ROFI_OPTS -p "Output")
                    if [[ -n "$selected" ]]; then
                        # Find sink by description
                        desc=$(echo "$selected" | sed 's/󰓃  //')
                        sink_name=$(pactl list sinks | grep -B 20 "$desc" | grep "Name:" | tail -1 | cut -d: -f2 | xargs)
                        [[ -n "$sink_name" ]] && pactl set-default-sink "$sink_name" && notify "Output: $desc"
                    fi
                fi
                ;;
            *"Input Device"*)
                # List audio sources (microphones)
                sources=$(pactl list sources short | grep -v monitor | while read -r id name _; do
                    desc=$(pactl list sources | grep -A 20 "Source #$id" | grep "Description:" | cut -d: -f2 | xargs)
                    [[ -n "$desc" ]] && echo "󰍬  $desc"
                done)

                if [[ -n "$sources" ]]; then
                    selected=$(echo "$sources" | rofi $ROFI_OPTS -p "Input")
                    if [[ -n "$selected" ]]; then
                        desc=$(echo "$selected" | sed 's/󰍬  //')
                        source_name=$(pactl list sources | grep -B 20 "$desc" | grep "Name:" | tail -1 | cut -d: -f2 | xargs)
                        [[ -n "$source_name" ]] && pactl set-default-source "$source_name" && notify "Input: $desc"
                    fi
                fi
                ;;
            *"Toggle Mute"*)
                wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
                if wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep -q MUTED; then
                    notify "Audio muted"
                else
                    notify "Audio unmuted"
                fi
                ;;
            *"Mute Mic"*)
                wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle
                if wpctl get-volume @DEFAULT_AUDIO_SOURCE@ | grep -q MUTED; then
                    notify "Microphone muted"
                else
                    notify "Microphone unmuted"
                fi
                ;;
            *"Settings"*)
                kitty --title "Audio" -e pulsemixer &
                exit 0
                ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# SCREENSHOTS
# ============================================
screenshots_menu() {
    RECORDINGS_DIR="$HOME/Videos/Recordings"

    while true; do
        choice=$(show_rofi "Screenshots" \
"󰹑  Area → Clipboard
󰹑  Full → Clipboard
󰏫  Area → Edit → Clipboard
󰕧  Record Area
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Area → Clipboard"*)
                grim -g "$(slurp)" - | wl-copy
                notify "Screenshot copied to clipboard"
                ;;
            *"Full → Clipboard"*)
                grim - | wl-copy
                notify "Screenshot copied to clipboard"
                ;;
            *"Edit"*)
                grim -g "$(slurp)" - | swappy -f -
                ;;
            *"Record Area"*)
                mkdir -p "$RECORDINGS_DIR"
                filename="$RECORDINGS_DIR/recording-$(date +%Y%m%d-%H%M%S).mp4"
                notify "Select area, recording starts in 3s..."
                geometry=$(slurp)
                if [[ -n "$geometry" ]]; then
                    sleep 3
                    notify "Recording... Press Super+Shift+R to stop"
                    wf-recorder -g "$geometry" -f "$filename"
                    if [[ -f "$filename" ]]; then
                        echo -n "$filename" | wl-copy
                        notify "Saved: $(basename "$filename")\n(Path copied to clipboard)"
                        nautilus "$RECORDINGS_DIR" &
                    fi
                fi
                ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# MEDIA
# ============================================
media_menu() {
    while true; do
        # Get now playing info
        now_playing=$(playerctl metadata --format '{{artist}} - {{title}}' 2>/dev/null)
        if [[ -z "$now_playing" ]]; then
            now_playing="Nothing playing"
        fi

        # Get play/pause state
        status=$(playerctl status 2>/dev/null)
        if [[ "$status" == "Playing" ]]; then
            play_entry="󰏤  Pause"
        else
            play_entry="󰐎  Play"
        fi

        choice=$(show_rofi "Media" \
"󰎈  $now_playing
󰒮  Previous
$play_entry
󰒭  Next
  Spotify
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Previous"*) playerctl previous ;;
            *"Play"*|*"Pause"*) playerctl play-pause ;;
            *"Next"*) playerctl next ;;
            *"Spotify"*) spotify & ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# THEMES
# ============================================
themes_menu() {
    local theme_cmd="$HOME/nixos/dotfiles/stow-common/.local/bin/theme"
    if [[ ! -x "$theme_cmd" ]]; then
        theme_cmd="$HOME/.local/bin/theme"
    fi

    while true; do
        current_theme=$(cat ~/.config/.current-theme 2>/dev/null || echo "unknown")

        choice=$(show_rofi "Themes ($current_theme)" \
"󰔎  Catppuccin Mocha
󰌪  Everforest
󰗀  Rose Pine
󰛩  Gruvbox
󰒘  Kanagawa
󰍂  Nord
󰒲  Cycle
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Catppuccin Mocha"*)
                "$theme_cmd" catppuccin-mocha && notify "Theme: Catppuccin Mocha" || notify "Theme switch failed"
                exit 0
                ;;
            *"Everforest"*)
                "$theme_cmd" everforest && notify "Theme: Everforest" || notify "Theme switch failed"
                exit 0
                ;;
            *"Rose Pine"*)
                "$theme_cmd" rose-pine && notify "Theme: Rose Pine" || notify "Theme switch failed"
                exit 0
                ;;
            *"Gruvbox"*)
                "$theme_cmd" gruvbox && notify "Theme: Gruvbox" || notify "Theme switch failed"
                exit 0
                ;;
            *"Kanagawa"*)
                "$theme_cmd" kanagawa && notify "Theme: Kanagawa" || notify "Theme switch failed"
                exit 0
                ;;
            *"Nord"*)
                "$theme_cmd" nord && notify "Theme: Nord" || notify "Theme switch failed"
                exit 0
                ;;
            *"Cycle"*)
                "$theme_cmd" && current=$(cat ~/.config/.current-theme 2>/dev/null) && notify "Theme: $current" || notify "Theme cycle failed"
                exit 0
                ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# WALLPAPER
# ============================================
wallpaper_menu() {
    WALLPAPER_BASE="$HOME/nixos/files/wallpapers"
    WAYPAPER_CONFIG="$HOME/.config/waypaper/config.ini"

    while true; do
        choice=$(show_rofi "Wallpaper" \
"󰸉  Change Wallpaper
󰒭  Next Wallpaper
󰉋  Open Wallpaper Folder
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Change Wallpaper"*)
                waypaper &
                exit 0
                ;;
            *"Next Wallpaper"*)
                # Get current wallpaper folder and file from waypaper config
                if [[ -f "$WAYPAPER_CONFIG" ]]; then
                    current_folder=$(grep "^folder" "$WAYPAPER_CONFIG" | cut -d'=' -f2 | xargs)
                    current_folder="${current_folder/#\~/$HOME}"
                    current_wallpaper=$(grep "^wallpaper" "$WAYPAPER_CONFIG" | cut -d'=' -f2 | xargs)
                    current_name=$(basename "$current_wallpaper")

                    # Get all wallpapers in folder
                    mapfile -t wallpapers < <(find "$current_folder" -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) | sort)

                    if [[ ${#wallpapers[@]} -gt 0 ]]; then
                        # Find current index and get next
                        next_wallpaper="${wallpapers[0]}"
                        for i in "${!wallpapers[@]}"; do
                            if [[ "$(basename "${wallpapers[$i]}")" == "$current_name" ]]; then
                                next_idx=$(( (i + 1) % ${#wallpapers[@]} ))
                                next_wallpaper="${wallpapers[$next_idx]}"
                                break
                            fi
                        done

                        # Set wallpaper with swww
                        swww img "$next_wallpaper" --transition-type any --transition-duration 1 &

                        # Update waypaper config
                        sed -i "s|^wallpaper = .*|wallpaper = $next_wallpaper|" "$WAYPAPER_CONFIG"

                        notify "Wallpaper: $(basename "$next_wallpaper")"
                    else
                        notify "No wallpapers found in folder"
                    fi
                else
                    notify "Waypaper config not found"
                fi
                exit 0
                ;;
            *"Open Wallpaper Folder"*)
                nautilus "$WALLPAPER_BASE" &
                exit 0
                ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# CONFIG
# ============================================
config_menu() {
    while true; do
        choice=$(show_rofi "Config" \
"󰌌  Keybinds
󰀻  Waybar
󰍹  Monitors
󱄅  NixOS Packages
󰘳  Shell Aliases
󰣀  SSH Clients
←  Back")
        rofi_exit=$?

        if [[ $rofi_exit -eq 10 ]]; then
            break
        fi

        case "$choice" in
            *"Keybinds"*) edit_config "Keybinds" ~/.config/hypr/keybinds.conf ;;
            *"Waybar"*) edit_config "Waybar" ~/.config/waybar/config.jsonc ;;
            *"Monitors"*) edit_config "Monitors" ~/.config/hypr/monitors.conf ;;
            *"NixOS Packages"*) edit_config "NixOS Packages" ~/nixos/home/simon/common-gui.nix ;;
            *"Shell Aliases"*) edit_config "Shell Aliases" ~/.zsh/aliases.zsh ;;
            *"SSH Clients"*) edit_config "SSH Config" ~/.ssh/config ;;
            *"Back"*|"") break ;;
        esac
    done
}

# ============================================
# ENTRY POINT
# ============================================
main_menu
