#!/usr/bin/env bash
set -e

# Usage: theme [theme-name]
THEME_NAME="${1:-catppuccin-mocha}"

KITTY_THEME_DIR="$HOME/nixos/dotfiles/stow-common/.config/kitty/themes"
WAYBAR_THEME_DIR="$HOME/.config/waybar/themes"
ROFI_THEME_DIR="$HOME/.config/rofi"
ROFI_CURRENT="$HOME/.config/rofi/config.rasi"

# -------------------------
# Kitty
# -------------------------
if [ ! -f "$KITTY_THEME_DIR/$THEME_NAME.conf" ]; then
    echo "❌ Kitty theme '$THEME_NAME' not found!"
    ls "$KITTY_THEME_DIR"/*.conf | xargs -n 1 basename | sed 's/.conf$//'
    exit 1
fi

ln -sf "$KITTY_THEME_DIR/$THEME_NAME.conf" "$KITTY_THEME_DIR/current.conf"
echo "✔ Kitty theme set to: $THEME_NAME"

if kitty @ ls >/dev/null 2>&1; then
    kitty @ load-config
    echo "✔ Kitty reloaded"
else
    echo "ℹ Kitty not running – will apply on next start"
fi

# -------------------------
# Waybar
# -------------------------
if [ ! -f "$WAYBAR_THEME_DIR/$THEME_NAME.css" ]; then
    echo "❌ Waybar theme '$THEME_NAME' not found!"
    ls "$WAYBAR_THEME_DIR"/*.css | xargs -n 1 basename | sed 's/.css$//'
    exit 1
fi

ln -sf "$WAYBAR_THEME_DIR/$THEME_NAME.css" "$WAYBAR_THEME_DIR/current.css"
echo "✔ Waybar theme set to: $THEME_NAME"

pkill waybar || true
waybar >/dev/null 2>&1 & disown
echo "✔ Waybar restarted"

# -------------------------
# Rofi
# -------------------------
if [ -f "$ROFI_THEME_DIR/$THEME_NAME.rasi" ]; then
    ln -sf "$ROFI_THEME_DIR/$THEME_NAME.rasi" "$ROFI_CURRENT"
    echo "✔ Rofi theme set to: $THEME_NAME"
else
    echo "ℹ Rofi theme '$THEME_NAME' not found, skipping Rofi"
fi

# -------------------------
# swaync
# -------------------------
SWAYNC_THEME_DIR="$HOME/.config/swaync/themes"
SWAYNC_CURRENT="$SWAYNC_THEME_DIR/current.css"

if [ ! -f "$SWAYNC_THEME_DIR/$THEME_NAME.css" ]; then
    echo "❌ swaync theme '$THEME_NAME' not found!"
    ls "$SWAYNC_THEME_DIR"/*.css | xargs -n 1 basename | sed 's/.css$//'
    exit 1
fi

# Create new current.css with correct imports
cat > "$SWAYNC_CURRENT" << EOF
/* Import color definitions first */
@import url("$THEME_NAME.css");

/* Import base styles that use the color definitions */
@import url("base-styles.css");
EOF

echo "✔ swaync theme set to: $THEME_NAME"

# Restart swaync to apply new theme
if systemctl --user restart swaync 2>/dev/null; then
    echo "✔ swaync restarted"
else
    echo "⚠ swaync restart failed, continuing..."
fi

# -------------------------
# swayosd
# -------------------------
SWAYOSD_THEME_DIR="$HOME/.config/swayosd/themes"
SWAYOSD_CURRENT="$SWAYOSD_THEME_DIR/current.css"

if [ ! -f "$SWAYOSD_THEME_DIR/$THEME_NAME.css" ]; then
    echo "❌ swayosd theme '$THEME_NAME' not found!"
    ls "$SWAYOSD_THEME_DIR"/*.css | xargs -n 1 basename | sed 's/.css$//'
    exit 1
fi

# Create new current.css with correct imports
cat > "$SWAYOSD_CURRENT" << EOF
/* Import color definitions first */
@import url("$THEME_NAME.css");

/* Import base styles that use the color definitions */
@import url("base-styles.css");
EOF

echo "✔ swayosd theme set to: $THEME_NAME"

# Restart swayosd to apply new theme
if systemctl --user restart swayosd 2>/dev/null; then
    echo "✔ swayosd restarted"
else
    echo "⚠ swayosd restart failed, continuing..."
fi

# -------------------------
# nwg-dock
# -------------------------
NWG_DOCK_THEME_DIR="$HOME/.config/nwg-dock-hyprland/themes"
NWG_DOCK_CURRENT="$HOME/.config/nwg-dock-hyprland/style.css"

if [ ! -f "$NWG_DOCK_THEME_DIR/$THEME_NAME.css" ]; then
    echo "❌ nwg-dock theme '$THEME_NAME' not found!"
    ls "$NWG_DOCK_THEME_DIR"/*.css | xargs -n 1 basename | sed 's/.css$//'
    exit 1
fi

# Create new style.css with correct imports
cat > "$NWG_DOCK_CURRENT" << EOF
/* Import color definitions first */
@import url("themes/$THEME_NAME.css");

/* Import base styles that use the color definitions */
@import url("base-styles.css");
EOF

echo "✔ nwg-dock theme set to: $THEME_NAME"

# Restart nwg-dock to apply new theme
pkill -f nwg-dock-hyprland || true
sleep 0.2
if nwg-dock-hyprland -nolauncher -d -hd 0 -iw "special" >/dev/null 2>&1 & then
    echo "✔ nwg-dock restarted"
else
    echo "⚠ nwg-dock restart failed, continuing..."
fi

# -------------------------
# wlogout
# -------------------------
WLOGOUT_THEME_DIR="$HOME/.config/wlogout/themes"
WLOGOUT_STYLE="$HOME/.config/wlogout/style.css"

if [ ! -f "$WLOGOUT_THEME_DIR/$THEME_NAME.css" ]; then
    echo "❌ wlogout theme '$THEME_NAME' not found!"
    ls "$WLOGOUT_THEME_DIR"/*.css | xargs -n 1 basename | sed 's/.css$//'
    exit 1
fi

# Create new style.css with correct imports
cat > "$WLOGOUT_STYLE" << EOF
/* Import color definitions first */
@import url("themes/$THEME_NAME.css");

/* Import base styles that use the color definitions */
@import url("base-styles.css");
EOF

echo "✔ wlogout theme set to: $THEME_NAME"

echo "✅ Theme switch complete: $THEME_NAME"
