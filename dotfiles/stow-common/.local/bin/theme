#!/usr/bin/env bash
set -e

# Hyprland/rofi keybinds often run with a minimal PATH.
# Ensure we can find Nix profile + system binaries when launched non-interactively.
export PATH="$HOME/.local/bin:$HOME/.nix-profile/bin:/etc/profiles/per-user/$USER/bin:/run/current-system/sw/bin:/usr/bin:/bin:$PATH"

# Make Kitty remote control work outside Kitty shells.
export KITTY_LISTEN_ON="${KITTY_LISTEN_ON:-unix:/tmp/kitty}"

# Base stow source directory (where config files live in git)
STOW_BASE="$HOME/nixos/dotfiles/stow-common/.config"

# Directory definitions
KITTY_THEME_DIR="$STOW_BASE/kitty/themes"
CURRENT_THEME_FILE="$HOME/.config/.current-theme"

# Available themes (based on kitty themes)
THEMES=($(ls "$KITTY_THEME_DIR"/*.conf 2>/dev/null | xargs -n 1 basename | sed 's/.conf$//' | grep -v current))

# Get current theme
CURRENT_THEME=""
[ -f "$CURRENT_THEME_FILE" ] && CURRENT_THEME=$(cat "$CURRENT_THEME_FILE")

# If no argument, cycle to next theme
if [ -z "$1" ]; then
    if [ -z "$CURRENT_THEME" ]; then
        THEME_NAME="${THEMES[0]}"
    else
        # Find current index and get next
        for i in "${!THEMES[@]}"; do
            if [ "${THEMES[$i]}" = "$CURRENT_THEME" ]; then
                NEXT_INDEX=$(( (i + 1) % ${#THEMES[@]} ))
                THEME_NAME="${THEMES[$NEXT_INDEX]}"
                break
            fi
        done
        # Fallback if current theme not found in list
        [ -z "$THEME_NAME" ] && THEME_NAME="${THEMES[0]}"
    fi
else
    THEME_NAME="$1"
fi

# More directory definitions
# Source directories (in stow/git) - used for symlink targets
ROFI_THEME_SOURCE="$STOW_BASE/rofi"
FIREFOX_THEME_SOURCE="$STOW_BASE/firefox-themes"
TELEGRAM_THEME_SOURCE="$STOW_BASE/telegram-themes"

# Runtime directories (in ~/.config) - where symlinks are created
WAYBAR_THEME_DIR="$HOME/.config/waybar/themes"
ROFI_CURRENT="$HOME/.config/rofi/config.rasi"
SWAYNC_THEME_DIR="$HOME/.config/swaync/themes"
SWAYNC_CURRENT="$SWAYNC_THEME_DIR/current.css"
SWAYOSD_THEME_DIR="$HOME/.config/swayosd/themes"
SWAYOSD_CURRENT="$SWAYOSD_THEME_DIR/current.css"
NWG_DOCK_THEME_DIR="$HOME/.config/nwg-dock-hyprland/themes"
NWG_DOCK_CURRENT="$HOME/.config/nwg-dock-hyprland/style.css"
WLOGOUT_THEME_DIR="$HOME/.config/wlogout/themes"
WLOGOUT_STYLE="$HOME/.config/wlogout/style.css"
FIREFOX_PROFILE_DIR="$HOME/.mozilla/firefox/z34ufndn.default"
FIREFOX_CHROME_DIR="$FIREFOX_PROFILE_DIR/chrome"
TELEGRAM_CURRENT="$HOME/.config/telegram-themes/current.tdesktop-theme"
WALLPAPER_BASE="$HOME/nixos/files/wallpapers"
WALLPAPER_STATE="$WALLPAPER_BASE/.theme-state.json"
WALLPAPER_THEME_DIR="$WALLPAPER_BASE/$THEME_NAME"
WAYPAPER_CONFIG="$HOME/.config/waypaper/config.ini"

# -------------------------
# Validate theme exists
# -------------------------
if [ ! -f "$KITTY_THEME_DIR/$THEME_NAME.conf" ]; then
    echo "❌ Theme '$THEME_NAME' not found! Available themes:"
    ls "$KITTY_THEME_DIR"/*.conf 2>/dev/null | xargs -n 1 basename | sed 's/.conf$//'
    exit 1
fi

# -------------------------
# Update all config files (fast, synchronous)
# -------------------------

# Kitty
ln -sf "$KITTY_THEME_DIR/$THEME_NAME.conf" "$KITTY_THEME_DIR/current.conf"

# Waybar
[ -f "$WAYBAR_THEME_DIR/$THEME_NAME.css" ] && \
    ln -sf "$WAYBAR_THEME_DIR/$THEME_NAME.css" "$WAYBAR_THEME_DIR/current.css"

# Rofi - symlink to source file in stow directory
[ -f "$ROFI_THEME_SOURCE/$THEME_NAME.rasi" ] && \
    ln -sf "$ROFI_THEME_SOURCE/$THEME_NAME.rasi" "$ROFI_CURRENT"

# swaync
[ -f "$SWAYNC_THEME_DIR/$THEME_NAME.css" ] && \
cat > "$SWAYNC_CURRENT" << EOF
@import url("$THEME_NAME.css");
@import url("base-styles.css");
EOF

# swayosd
[ -f "$SWAYOSD_THEME_DIR/$THEME_NAME.css" ] && \
cat > "$SWAYOSD_CURRENT" << EOF
@import url("$THEME_NAME.css");
@import url("base-styles.css");
EOF

# nwg-dock
[ -f "$NWG_DOCK_THEME_DIR/$THEME_NAME.css" ] && \
cat > "$NWG_DOCK_CURRENT" << EOF
@import url("themes/$THEME_NAME.css");
@import url("base-styles.css");
EOF

# wlogout
[ -f "$WLOGOUT_THEME_DIR/$THEME_NAME.css" ] && \
cat > "$WLOGOUT_STYLE" << EOF
@import url("themes/$THEME_NAME.css");
@import url("base-styles.css");
EOF

# Firefox - symlink to source files in stow directory
if [ -f "$FIREFOX_THEME_SOURCE/$THEME_NAME/chrome/userChrome.css" ]; then
    mkdir -p "$FIREFOX_CHROME_DIR"
    ln -sf "$FIREFOX_THEME_SOURCE/$THEME_NAME/chrome/userChrome.css" "$FIREFOX_CHROME_DIR/userChrome.css"
    ln -sf "$FIREFOX_THEME_SOURCE/$THEME_NAME/chrome/userContent.css" "$FIREFOX_CHROME_DIR/userContent.css"
fi

# Telegram - symlink to source file in stow directory
if [ -f "$TELEGRAM_THEME_SOURCE/$THEME_NAME.tdesktop-theme" ]; then
    ln -sf "$TELEGRAM_THEME_SOURCE/$THEME_NAME.tdesktop-theme" "$TELEGRAM_CURRENT"
fi

# -------------------------
# Wallpaper config (before restarts)
# -------------------------
NEW_WALLPAPER=""
if [ -d "$WALLPAPER_THEME_DIR" ]; then
    # Save current wallpaper to old theme
    if [ -f "$WAYPAPER_CONFIG" ]; then
        CURRENT_WALLPAPER=$(grep "^wallpaper" "$WAYPAPER_CONFIG" | cut -d'=' -f2 | xargs)
        CURRENT_FOLDER=$(grep "^folder" "$WAYPAPER_CONFIG" | cut -d'=' -f2 | xargs)
        CURRENT_FOLDER="${CURRENT_FOLDER/#\~/$HOME}"
        OLD_THEME=$(basename "$CURRENT_FOLDER")

        if [ -n "$CURRENT_WALLPAPER" ] && [ "$OLD_THEME" != "wallpapers" ] && [ -f "$WALLPAPER_STATE" ]; then
            WALLPAPER_FILENAME=$(basename "$CURRENT_WALLPAPER")
            jq --arg theme "$OLD_THEME" --arg wp "$WALLPAPER_FILENAME" \
                '.[$theme] = $wp' "$WALLPAPER_STATE" > "$WALLPAPER_STATE.tmp" 2>/dev/null \
                && mv "$WALLPAPER_STATE.tmp" "$WALLPAPER_STATE"
        fi
    fi

    # Get saved wallpaper for new theme
    [ -f "$WALLPAPER_STATE" ] && \
        NEW_WALLPAPER=$(jq -r --arg theme "$THEME_NAME" '.[$theme] // empty' "$WALLPAPER_STATE" 2>/dev/null)

    # Fallback to first image
    if [ -z "$NEW_WALLPAPER" ] || [ ! -f "$WALLPAPER_THEME_DIR/$NEW_WALLPAPER" ]; then
        NEW_WALLPAPER=$(find "$WALLPAPER_THEME_DIR" -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) | head -1 | xargs basename 2>/dev/null || true)
    fi

    # Update waypaper config
    [ -f "$WAYPAPER_CONFIG" ] && {
        sed -i "s|^folder = .*|folder = $WALLPAPER_THEME_DIR|" "$WAYPAPER_CONFIG"
        [ -n "$NEW_WALLPAPER" ] && sed -i "s|^wallpaper = .*|wallpaper = $WALLPAPER_THEME_DIR/$NEW_WALLPAPER|" "$WAYPAPER_CONFIG"
    }
fi

echo "✔ Config updated for: $THEME_NAME"

# -------------------------
# Wallpaper (first for immediate visual feedback)
# -------------------------
if [ -n "$NEW_WALLPAPER" ] && [ -f "$WALLPAPER_THEME_DIR/$NEW_WALLPAPER" ] && command -v swww &>/dev/null; then
    swww img "$WALLPAPER_THEME_DIR/$NEW_WALLPAPER" --transition-type any --transition-duration 1 &
    echo "✔ Wallpaper set to: $NEW_WALLPAPER"
fi

# -------------------------
# Restart apps sequentially
# -------------------------

# Kitty
# When run from Hyprland keybind/rofi, `KITTY_LISTEN_ON` is often missing.
# Prefer a stable socket if configured, otherwise fall back to env-based remote control.
KITTY_TO="unix:/tmp/kitty"
if kitty @ load-config >/dev/null 2>&1; then
    echo "✔ Kitty reloaded"
elif [ -S "/tmp/kitty" ] && kitty @ --to "$KITTY_TO" load-config >/dev/null 2>&1; then
    echo "✔ Kitty reloaded"
fi

# Waybar
WAYBAR_BIN="$(command -v waybar 2>/dev/null || true)"
if [ -z "$WAYBAR_BIN" ]; then
    for candidate in "/run/current-system/sw/bin/waybar" "$HOME/.nix-profile/bin/waybar" "/etc/profiles/per-user/$USER/bin/waybar"; do
        if [ -x "$candidate" ]; then
            WAYBAR_BIN="$candidate"
            break
        fi
    done
fi

if [ -n "$WAYBAR_BIN" ]; then
    # In Nix setups the process name isn't always exactly "waybar", so match by command line.
    WAYBAR_MATCH='(^|/)(waybar)(\s|$)'

    if pgrep -f "$WAYBAR_MATCH" >/dev/null 2>&1; then
        pkill -TERM -f "$WAYBAR_MATCH" || true
        # Wait for a clean exit to avoid double bars.
        for _ in $(seq 1 10); do
            pgrep -f "$WAYBAR_MATCH" >/dev/null 2>&1 || break
            sleep 0.1
        done
        if pgrep -f "$WAYBAR_MATCH" >/dev/null 2>&1; then
            pkill -KILL -f "$WAYBAR_MATCH" || true
            sleep 0.1
        fi
    fi

    nohup "$WAYBAR_BIN" >/dev/null 2>&1 &
    echo "✔ Waybar restarted"
fi

# swaync
systemctl --user restart swaync 2>/dev/null && echo "✔ swaync restarted"

# swayosd
systemctl --user restart swayosd 2>/dev/null && echo "✔ swayosd restarted"

# nwg-dock
if command -v nwg-dock-hyprland &>/dev/null; then
    pkill -f nwg-dock-hyprland || true
    sleep 0.2
    nwg-dock-hyprland -nolauncher -d -hd 0 -iw "special" >/dev/null 2>&1 &
    echo "✔ nwg-dock restarted"
fi

# Firefox (notify only - don't force restart to avoid losing work)
if [ -f "$FIREFOX_CHROME_DIR/userChrome.css" ]; then
    echo "✔ Firefox theme updated (restart Firefox to apply)"
fi

# Telegram
if [ -f "$TELEGRAM_CURRENT" ] && command -v telegram-desktop &>/dev/null; then
    pkill -f telegram-desktop || true
    sleep 0.3
    nohup telegram-desktop >/dev/null 2>&1 &
    echo "✔ Telegram restarted"
fi

# Save current theme
echo "$THEME_NAME" > "$CURRENT_THEME_FILE"

echo "✅ Theme switched to: $THEME_NAME"
