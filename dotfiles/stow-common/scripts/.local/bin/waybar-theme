#!/run/current-system/sw/bin/bash
# Waybar theme switcher

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$(dirname "$(dirname "$(dirname "$(dirname "$SCRIPT_DIR")")")")" && pwd)"
THEME_DIR="$HOME/.config/themes"
CURRENT_FILE="$THEME_DIR/current"

log() {
    echo "[waybar-theme] $1"
}

error() {
    echo "[waybar-theme] ERROR: $1" >&2
    exit 1
}

get_current_theme() {
    if [[ -f "$CURRENT_FILE" ]]; then
        cat "$CURRENT_FILE"
    else
        echo "catppuccin-mocha"
    fi
}

apply_waybar_theme() {
    local theme="$1"
    local template_file="$DOTFILES_DIR/themes/common/waybar.css.template"
    local override_file="$DOTFILES_DIR/themes/$theme/waybar-overrides.css"
    local output_file="${WAYBAR_OUTPUT_FILE:-$HOME/.config/waybar/style.css}"
    
    log "Updating Waybar theme: $theme"
    
    # Process template with current theme colors
    if [[ -f "$template_file" ]]; then
        "$SCRIPT_DIR/process-template" "$template_file" "$output_file"
        
        # Apply theme-specific overrides if they exist
        if [[ -f "$override_file" ]]; then
            echo "" >> "$output_file"
            echo "/* Theme-specific overrides for $theme */" >> "$output_file"
            cat "$override_file" >> "$output_file"
        fi
        
        log "Waybar theme applied successfully"
        
        # Reload Waybar
        if pgrep -x waybar > /dev/null; then
            pkill -USR1 waybar
            log "Waybar reloaded"
        fi
    else
        error "Template file not found: $template_file"
    fi
}

# Main execution
case "${1:-}" in
    "")
        # Apply current theme
        apply_waybar_theme "$(get_current_theme)"
        ;;
    *)
        # Apply specified theme
        apply_waybar_theme "$1"
        ;;
esac